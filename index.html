<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/clike/clike.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/monokai.min.css">
    <title>CodeEditor CE</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        #editor {
            height: 500px;
            width: 700px;
            /* border: 2px solid red; */
        }
        .CodeMirror {
            height: 100%;
        }
        button {
            height: 100px;
            width: 100px;
            margin-top: 10px;
        }
        #outputDiv {
            display: flex;
            height: 70px;
            width: 700px;
            margin-top: 10px;
            /* border: 2px solid red; */
        }
        #outputDiv #output {
            overflow-y: auto;
            width: 590px;
            height: 100px;
            margin-top: 10px;
            margin-left: 10px;
            color: aliceblue;
            background-color: #272822;
            /* border: 2px solid red; */
        }
    </style>
</head>
<body>
        <div id="editor"></div>
        <div id="outputDiv">
            <button onclick="submitCode()">RUN</button>
            <div id="output"></div>
        </div>
</body>
<script>
    let editor;

    window.onload = () => {
        editor = CodeMirror(document.getElementById('editor'), {
            mode: "text/x-c++src",
            theme: "monokai",
            lineNumbers: true,
            lineWrapping: true,
        })
    }

    function parseTextResponse(response) {
        var lines = response.split('\n');
        var result = {
            stdout: '',
            stderr: '',
            exitCode: null
        }

        var currentSection = null;

        for(var i = 0 ; i < lines.length ; i++) {
            var line = lines[i].trim();

            if (line === '') continue;

            if (line.indexOf('Standard out:') === 0) {
                currentSection = 'stdout';
                continue;
            } else if (line.indexOf('Standard error:') === 0) {
                currentSection = 'stderr';
                continue;
            } else if (line.indexOf('exited with result code') !== -1) {
                result.exitCode = parseInt(line.split(' ').pop(), 10);
                continue;
            }

            if (currentSection) {
                result[currentSection] += line + '\n';
            }
        }

        result.stdout = result.stdout.trim();
        result.stderr = result.stderr.trim();

        return result;
    }

    async function compileCode(sourceCode) {

        ApiUrl = "https://godbolt.org/api/compiler/g132/compile";

        const requestOptions = {
            method: 'POST',
            headers: { 'Content-Type' : 'application/json'},
            body: JSON.stringify({
                source: sourceCode,
                options: {
                    userArguments: "-std=c++17 -O2",
                    compilerOptions: {
                        skipAsm: true,
                        executorRequest: true
                    },
                    filters: { execute: true }
                }
            })
        }

        try {
            const response = await fetch(ApiUrl, requestOptions);
            const textResponse = await response.text();
            const responseObj = parseTextResponse(textResponse);

            console.log(`stdout: ${responseObj.stdout} \nstderr: ${responseObj.stderr} \nexitcode: ${responseObj.exitCode}`);
            return responseObj;

        } catch (error) {
            console.error('Error:', error);
            return null;
        }
    }

    function submitCode() {
        const sourceCode = editor.getValue();
        const outputWindow = document.getElementById('output');
        compileCode(sourceCode)
            .then(output => outputWindow.innerHTML = `stdout: <br>${output.stdout.replace(/\n/g, '<br>')} <br> stderr: <br>${output.stderr} <br> exitCode: <br>${output.exitCode}`);
    }
    
</script>
</html>